#!/bin/bash

# Script de configuración para el Sistema de Informes Psicológicos
# Este script prepara el entorno de desarrollo y producción

echo "===================================================="
echo "  Sistema de Informes Psicológicos - Configuración  "
echo "===================================================="

# Crear directorio para imágenes estáticas si no existe
mkdir -p frontend/assets/images
echo "✓ Directorio de imágenes creado"

# Crear imagen de placeholder para logos
if [ ! -f "frontend/assets/images/placeholder-logo.png" ]; then
    echo "Creando imagen placeholder..."
    # Si convert (ImageMagick) está instalado, crear una imagen
    if command -v convert &> /dev/null; then
        convert -size 200x100 canvas:lightgray \
                -font Arial -pointsize 18 -fill gray \
                -gravity center -annotate 0 "Logo" \
                frontend/assets/images/placeholder-logo.png
        echo "✓ Imagen placeholder creada"
    else
        echo "⚠ ImageMagick no está instalado. La imagen placeholder no se ha creado."
        echo "  Puedes instalar ImageMagick o crear manualmente la imagen placeholder."
    fi
fi

# Instalar dependencias
echo "Instalando dependencias..."
npm install
echo "✓ Dependencias instaladas"

# Crear archivo .env si no existe
if [ ! -f .env ]; then
    echo "Creando archivo .env..."
    cat > .env << EOL
MONGO_URI=mongodb://localhost:27017/psychological-reports
JWT_SECRET=$(openssl rand -hex 32)
PORT=5000
EMAIL_USER=your_email@gmail.com
EMAIL_PASS=your_email_password
FRONTEND_URL=http://localhost:5000
NODE_ENV=development
EOL
    echo "✓ Archivo .env creado con un JWT_SECRET seguro"
fi

# Verificar conexión a MongoDB
echo "Verificando conexión a MongoDB..."
mongo --eval "db.version()" mongodb://localhost:27017/psychological-reports > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "✓ Conexión a MongoDB exitosa"
else
    echo "⚠ No se pudo conectar a MongoDB. Asegúrate de que MongoDB esté en ejecución."
    echo "  La aplicación requiere MongoDB para funcionar correctamente."
fi

# Crear scripts para iniciar la aplicación
echo "Creando scripts de inicio..."

# Añadir script para iniciar en desarrollo
npm set-script dev "nodemon backend/server.js"
# Añadir script para iniciar en producción
npm set-script start "node backend/server.js"
# Añadir script para configuración
npm set-script setup "bash ./setup.sh"

echo "✓ Scripts de inicio creados"

# Mensaje final
echo ""
echo "===================================================="
echo "  Configuración completada con éxito                "
echo "===================================================="
echo ""
echo "Para ejecutar la aplicación en modo desarrollo:"
echo "  npm run dev"
echo ""
echo "Para ejecutar la aplicación en modo producción:"
echo "  npm start"
echo ""
echo "Accede a la aplicación en: http://localhost:5000"
echo ""
echo "Nota: Asegúrate de que MongoDB esté en ejecución"
echo "===================================================="